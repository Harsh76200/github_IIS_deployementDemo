name: Fast Deploy to IIS (.NET 8 + Vite)

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    # ---------------------------
    # 1. Checkout Latest Code
    # ---------------------------
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # ---------------------------
    # 2. Setup .NET 8 (cached)
    # ---------------------------
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        cache: true

    # ---------------------------
    # 3. Build Backend (.NET 8 API)
    # Publish ONLY the .csproj (NOT the solution)
    # ---------------------------
    - name: Publish .NET Backend
      run: dotnet publish "./github_IIS_deployementDemo.Server/github_IIS_deployementDemo.Server.csproj" -c Release -o ./publish

    # ---------------------------
    # 4. Build React (Vite Frontend)
    # ---------------------------
    - name: Install Node Dependencies & Build Vite
      run: |
        cd github_iis_deployementdemo.client
        npm install
        npm run build

    # ---------------------------
    # 5. Copy Vite /dist â†’ .NET wwwroot
    # ---------------------------
    - name: Merge React build into .NET wwwroot
      shell: powershell
      run: |
        $source = "$(pwd)\github_iis_deployementdemo.client\dist\*"
        $destination = "$(pwd)\publish\wwwroot"
        Write-Host "Copying React dist to publish/wwwroot..."
        Copy-Item -Path $source -Destination $destination -Recurse -Force

    # ---------------------------
    # 6. Deploy to IIS via Robocopy (FASTEST)
    # ---------------------------
    - name: Deployment to IIS
      shell: powershell
      run: |
        Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
        Import-Module WebAdministration
        
        $source = "$(pwd)\publish"
        $destination = "C:\www\githubActionDemo.com"

        Write-Host "Stopping IIS website..."
        Stop-Website -Name "githubActionDemo.com"

        Write-Host "Syncing files to IIS folder (fast delta copy)..."
        robocopy $source $destination /MIR /NFL /NDL /NP /NJH /NJS

        Write-Host "Starting IIS website..."
        Start-Website -Name "githubActionDemo.com"

