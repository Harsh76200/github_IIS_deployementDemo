name: Fast Deploy to IIS (.NET 8)

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:

      # Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Faster, no full git history

      # Setup .NET (cached)
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          cache: true    # Caches NuGet packages automatically

      # Build + Publish (single command)
      # MUCH FASTER than running build + publish separately
      - name: Publish Project
        run: dotnet publish "./github_IIS_deployementDemo.Server/github_IIS_deployementDemo.Server.csproj" -c Release -o ./publish

      # Deploy only modified files (FAST)
      - name: Deploy to IIS (delta copy)
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          Import-Module WebAdministration

          $source = "$(pwd)\publish"
          $destination = "C:\www\githubActionDemo.com"

          Write-Host "Stopping website..."
          Stop-Website -Name "githubActionDemo.com"

          Write-Host "Copying changed files ONLY..."
          robocopy $source $destination /MIR /NFL /NDL /NP /NJH /NJS

          Write-Host "Starting website..."
          Start-Website -Name "githubActionDemo.com"
